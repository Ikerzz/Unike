{% extends "templates/layout.twig" %}

{% block css %}
 <style>
    .productContainer{
        gap: 10px;
    }
    .sizes {
        width: 50px;
    }

    .table td{
        border: none!important;
    }

    .buttonCart:checked {
        border: none!important;
    }
 </style>
{% endblock %}

{% block content %}
    <div class="container-fluid row w-100 mt-4 mr-0 ml-0" id="app">
        <div class="cols-12 d-flex justify-content-center w-100">

        <input class="" id="searchbar" onkeyup="search_shirt()" type="text" name="search" placeholder="Busca tu producto...">

        <button class="btn btn-primary" data-toggle="modal" data-target="#cartModal"><i class="fa-solid fa-cart-shopping"></i> ({- totalItems
            -})
        </button>

        </div>

        <div class="cols-12 w-100">
            <!-- Modal -->
            <div class="modal fade" id="cartModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Carrito</h3>
                        </div>
                        <div class="modal-body">
                            <shopping-cart inline-template :items="cartItems">
                                    <table class="table table-cart">
                                        <tr v-for="(item, index) in items">
                                            <td>{- item.nombre -}</td>
                                            <td style="width: 120px!important;">
                                                <input v-model="item.cantidad" class="form-control input-qty"
                                                       type="number" min="1">
                                            </td>
                                            <td class="text-right">{- item.precio -} €</td>
                                            <td>
                                                <button @click="removeItem(index)">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        <tr v-show="items.length === 0">
                                            <td colspan="4" class="text-center" style="border:none!important;">El carrito está vacío!</td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                        </tr>
                                        <tr v-show="items.length > 0">
                                            <td></td>
                                            <td colspan="3" style="border-top: 1px solid #dee2e6!important;" class="text-right">Total del Carrito {- Total -} €</td>
                                        </tr>
                                    </table>
                                <!-- /.container -->
                            </shopping-cart>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container-fluid p-0 row m-0">
                <div class="row col-12 d-flex flex-row justify-content-center">
                    <div class="col-2 m-5 showSearch" v-for="(item,index) in items">
                        <div class="product">
                            <div class="product-image">
                                <a :href="'/men/shirts/' + item.id + '?id=' + item.id + '&' + 'category=' + item.categoria" class="image" :name="item.id">
                                    <img class="img-1" :src="item.url" :alt="item.nombre">
                                    <img class="img-2" :src="item.back_url" :alt="item.nombre">
                                </a>
                                <ul class="product-links">
                                    <li>
                                        <button @click="addToCart(item)" class="btn btn-outline-dark buttonCart">
                                            <i class="fa fa-shopping-cart"></i>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="d-flex flex-column product-content productContainer">
                                <ul class="rating">
                                    <li class="disable">(Reviews en el producto)</li>
                                </ul>
                                <h3 class="title"><a :href="'/men/shirts/' + item.id + '?id=' + item.id + '&' + 'category=' + item.categoria" id="shirtName">{- item.nombre -}</a></h3>
                                <select class="sizes" id="sizes">
                                    <option value="xl">xl</option>
                                    <option value="l">l</option>
                                    <option value="m">m</option>
                                    <option value="s">s</option>
                                    <option value="xs">xs</option>
                                </select>
                                <div class="">{- item.precio -} €</div>
                                <div class="boton">
                                    <button @click="addToCart(item)" class="btn btn-sm btn-light p-2">
                                        Añadir al carrito
                                    </button>
                                </div>
                            </div>
                       </div>
                    </div>
                </div>
            </div>

        </div>
    </div>


{% endblock %}


{% block js %}
    <script>
        function search_shirt() {
            let input = document.getElementById('searchbar').value
            input = input.toLowerCase();
            let x = document.getElementsByClassName('showSearch');

            console.log(x[0].children[0].children[1].children[1].innerText);

            for (i = 0; i < x.length; i++) {
                if (!x[i].children[0].children[1].children[1].innerText.toLowerCase().includes(input)) {
                    x[i].style.display = "none";
                } else {
                    x[i].style.display = "block";
                }
            }
        }

        const products = {{ productData|json_encode|raw }};
        console.log(products);

        // Componente carrito (x)

        Vue.component('shopping-cart', {
            props: ['items'],
            computed: {
                Total() {
                    let total = 0;
                    this.items.forEach(item => {
                        total += (item.precio * item.cantidad);
                    });
                    return total;
                }
            },

            methods: {
                // Remover item de la lista del carrito según su index(botón borrar)
                removeItem(index) {
                    this.items.splice(index, 1)
                }
            }
        })

        const vm = new Vue({
            el: '#app',
            delimiters: ['{-', '-}'],
            data: {
                cartItems: [],
                items: products
            },

            computed: {
                totalItems() {
                    return this.cartItems.reduce((accumulator, item) => {
                        return accumulator + item.cantidad;
                    }, 0);
                }
            },

            methods: {
                // Funcion añadir al carrito
                addToCart(itemToAdd) {
                    let found = false;

                    // Añadir item || Aumentar Cantidad
                    let itemInCart = this.cartItems.filter(item => item.id === itemToAdd.id);
                    let isItemInCart = itemInCart.length > 0;

                    if (isItemInCart === false) {
                        this.cartItems.push(Vue.util.extend({}, itemToAdd));
                    } else {
                        itemInCart[0].cantidad += itemToAdd.cantidad;
                    }

                    itemToAdd.cantidad = 1;
                }
            }
        })

    </script>
{% endblock %}